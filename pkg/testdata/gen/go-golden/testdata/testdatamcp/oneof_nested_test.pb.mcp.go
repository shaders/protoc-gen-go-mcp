// Code generated by protoc-gen-mcp-go. DO NOT EDIT.
// source: testdata/oneof_nested_test.proto

package testdatamcp

import (
	testdata "github.com/shaders/protoc-gen-go-mcp/pkg/testdata/gen/go-golden/testdata"
)

import (
	"context"
	"strings"
	"github.com/mark3labs/mcp-go/mcp"
	mcpserver "github.com/mark3labs/mcp-go/server"
	"encoding/json"
	"google.golang.org/protobuf/encoding/protojson"
	grpc "google.golang.org/grpc"
	"github.com/shaders/protoc-gen-go-mcp/pkg/runtime"
	"google.golang.org/protobuf/proto"
	"google.golang.org/protobuf/reflect/protoreflect"
)

var (
	OneOfNestedTestService_GrantDeviceDataModificationRightOnApplicationTool = runtime.Tool{Name: "phpt1g_TestService_GrantDeviceDataModificationRightOnApplication", Description: "", JSONSchema: "{\"$defs\":{\"DeviceDataApplications\":{\"properties\":{\"application_code\":{\"type\":\"string\"}},\"required\":[],\"type\":\"object\"}},\"$schema\":\"https://json-schema.org/draft/2020-12/schema\",\"properties\":{\"kindOneOfType\":{\"oneOf\":[{\"properties\":{\"device_data_applications\":{\"$ref\":\"#/$defs/DeviceDataApplications\"},\"object_type\":{\"const\":\"device_data_applications\",\"type\":\"string\"}},\"required\":[\"object_type\",\"device_data_applications\"],\"title\":\"device_data_applications\",\"type\":\"object\"}]}},\"required\":[\"kindOneOfType\"],\"type\":\"object\"}"}
)

// OneOfNestedTestServiceClient is compatible with the grpc-go client interface.
type OneOfNestedTestServiceClient interface {
	GrantDeviceDataModificationRightOnApplication(ctx context.Context, req *testdata.GrantDeviceDataModificationRightOnApplicationRequest, opts ...grpc.CallOption) (*testdata.GrantDeviceDataModificationRightOnApplicationResponse, error)
}

// TODO: BUG: https://github.com/anthropics/claude-code/issues/3084
// OneOfNestedTestServiceNormalizeTopLevelJSONStringsForOneofs scans m's top level and, for keys that are members
// of any (or selected) oneof(s) in the given proto message type, it will parse string values
// that look like JSON and replace them with the parsed value.
// If oneofNames is empty, all oneofs are considered. Otherwise only the named oneofs are used.
func OneOfNestedTestServiceNormalizeTopLevelJSONStringsForOneofs(
	m map[string]interface{},
	msg proto.Message,
	oneofNames ...string,
) (changed bool) {
	if m == nil || msg == nil {
		return false
	}

	md := msg.ProtoReflect().Descriptor()
	// Build a set of target oneof descriptors
	var targetOneofs map[protoreflect.OneofDescriptor]struct{}
	if len(oneofNames) > 0 {
		targetOneofs = map[protoreflect.OneofDescriptor]struct{}{}
	outer:
		for i := 0; i < md.Oneofs().Len(); i++ {
			od := md.Oneofs().Get(i)
			for _, name := range oneofNames {
				if string(od.Name()) == name {
					targetOneofs[od] = struct{}{}
					continue outer
				}
			}
		}
	}

	// Collect JSON names of fields that belong to the target oneof(s)
	jsonNames := map[string]struct{}{}
	for i := 0; i < md.Fields().Len(); i++ {
		fd := md.Fields().Get(i)
		if fd.ContainingOneof() == nil {
			continue
		}
		if targetOneofs != nil {
			if _, ok := targetOneofs[fd.ContainingOneof()]; !ok {
				continue
			}
		}
		// fd.JSONName() is the canonical JSON field name ("cat", "dog", ...)
		jsonNames[fd.JSONName()] = struct{}{}
		// Also consider the proto field name in case your map uses snake_case
		jsonNames[string(fd.Name())] = struct{}{}
	}

	// Rewrite top-level stringified JSON for those keys
	for k, v := range m {
		if _, ok := jsonNames[k]; !ok {
			continue
		}
		s, ok := v.(string)
		if !ok {
			continue
		}
		trim := strings.TrimSpace(s)
		if trim == "" || !(strings.HasPrefix(trim, "{") || strings.HasPrefix(trim, "[")) {
			continue
		}
		var parsed any
		if err := json.Unmarshal([]byte(trim), &parsed); err != nil {
			continue // ignore if it's not valid JSON
		}
		m[k] = parsed
		changed = true
	}
	return changed
}

// OneOfNestedTestServiceTransformOneOfFields transforms discriminated union fields back to protobuf oneOf format
func OneOfNestedTestServiceTransformOneOfFields(m map[string]interface{}) {
	OneOfNestedTestServiceTransformOneOfFieldsRecursive(m)
}

// OneOfNestedTestServiceTransformOneOfFieldsRecursive recursively transforms oneOf fields in nested objects
func OneOfNestedTestServiceTransformOneOfFieldsRecursive(obj interface{}) {
	switch v := obj.(type) {
	case map[string]interface{}:
		// Transform oneOf fields in this object
		for key, value := range v {
			// Check if this looks like a oneOf discriminated union (must have OneOfType postfix)
			if strings.HasSuffix(key, "OneOfType") {
				if unionObj, ok := value.(map[string]interface{}); ok {
					if typeField, hasType := unionObj["object_type"]; hasType {
						if typeStr, ok := typeField.(string); ok {
							// First try to extract the field that matches the object_type
							// (for message types with $ref)
							if fieldValue, hasField := unionObj[typeStr]; hasField {
								// Move the field value directly to the parent level
								v[typeStr] = fieldValue
								delete(v, key)
							} else {
								// Fall back to old logic: create object without object_type field
								// (for primitive types or inline objects)
								variantObj := make(map[string]interface{})
								for k, val := range unionObj {
									if k != "object_type" {
										variantObj[k] = val
									}
								}
								// Replace the union object with the variant object
								v[typeStr] = variantObj
								delete(v, key)
							}
						}
					}
				}
			}
		}

		// Recursively process all values
		for _, value := range v {
			OneOfNestedTestServiceTransformOneOfFieldsRecursive(value)
		}
	case []interface{}:
		// Process array elements
		for _, item := range v {
			OneOfNestedTestServiceTransformOneOfFieldsRecursive(item)
		}
	}
}

// ForwardToOneOfNestedTestServiceClient registers a gRPC client, to forward MCP calls to it.
func ForwardToOneOfNestedTestServiceClient(s *mcpserver.MCPServer, client OneOfNestedTestServiceClient, opts ...runtime.Option) {
	config := runtime.NewConfig()
	for _, opt := range opts {
		opt(config)
	}
	GrantDeviceDataModificationRightOnApplicationToolDef := OneOfNestedTestService_GrantDeviceDataModificationRightOnApplicationTool

	// Convert simple Tool to mcp.Tool
	GrantDeviceDataModificationRightOnApplicationTool := mcp.Tool{
		Name:           GrantDeviceDataModificationRightOnApplicationToolDef.Name,
		Description:    GrantDeviceDataModificationRightOnApplicationToolDef.Description,
		RawInputSchema: json.RawMessage(GrantDeviceDataModificationRightOnApplicationToolDef.JSONSchema),
	}

	// Add extra properties to schema if configured
	if len(config.ExtraProperties) > 0 {
		GrantDeviceDataModificationRightOnApplicationTool = runtime.AddExtraPropertiesToTool(GrantDeviceDataModificationRightOnApplicationTool, config.ExtraProperties)
	}

	s.AddTool(GrantDeviceDataModificationRightOnApplicationTool, func(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
		var req testdata.GrantDeviceDataModificationRightOnApplicationRequest

		message := request.GetArguments()

		// Transform oneOf discriminated unions back to protobuf format
		OneOfNestedTestServiceTransformOneOfFields(message)

		// Limit to the "kind" oneof (optional). If you omit it, all oneofs are considered.
		// TODO: checking that the bug was fixed
		// _ = OneOfNestedTestServiceNormalizeTopLevelJSONStringsForOneofs(message, &req, "")

		// Extract extra properties if configured
		for _, prop := range config.ExtraProperties {
			if propVal, ok := message[prop.Name]; ok {
				ctx = context.WithValue(ctx, prop.ContextKey, propVal)
			}
		}

		marshaled, err := json.Marshal(message)
		if err != nil {
			return nil, err
		}

		if err := (protojson.UnmarshalOptions{DiscardUnknown: true}).Unmarshal(marshaled, &req); err != nil {
			return nil, err
		}

		resp, err := client.GrantDeviceDataModificationRightOnApplication(ctx, &req)
		if err != nil {
			return runtime.HandleError(err)
		}

		marshaled, err = (protojson.MarshalOptions{UseProtoNames: true, EmitDefaultValues: true}).Marshal(resp)
		if err != nil {
			return nil, err
		}
		return mcp.NewToolResultText(string(marshaled)), nil
	})
}
