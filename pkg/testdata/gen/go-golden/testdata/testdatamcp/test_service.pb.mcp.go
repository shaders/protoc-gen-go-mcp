// Code generated by protoc-gen-mcp-go. DO NOT EDIT.
// source: testdata/test_service.proto

package testdatamcp

import (
	testdata "github.com/shaders/protoc-gen-go-mcp/pkg/testdata/gen/go-golden/testdata"
)

import (
	"context"
	"strings"
	"github.com/mark3labs/mcp-go/mcp"
	mcpserver "github.com/mark3labs/mcp-go/server"
	"encoding/json"
	"google.golang.org/protobuf/encoding/protojson"
	grpc "google.golang.org/grpc"
	"github.com/shaders/protoc-gen-go-mcp/pkg/runtime"
)

var (
	TestService_CreateItemTool            = runtime.Tool{Name: "testdata_TestService_CreateItem", Description: "CreateItem creates a new item\n", JSONSchema: "{\"$defs\":{\"ProductDetails\":{\"properties\":{\"price\":{\"description\":\"Product price in dollars\",\"type\":\"number\"},\"quantity\":{\"description\":\"Available quantity\",\"type\":\"integer\"}},\"required\":[],\"type\":\"object\"},\"ServiceDetails\":{\"properties\":{\"duration\":{\"description\":\"Service duration (e.g. \\\"1h\\\", \\\"30m\\\")\",\"type\":\"string\"},\"recurring\":{\"description\":\"Whether this is a recurring service\",\"type\":\"boolean\"}},\"required\":[],\"type\":\"object\"}},\"$schema\":\"https://json-schema.org/draft/2020-12/schema\",\"properties\":{\"description\":{\"description\":\"Optional field\",\"type\":\"string\"},\"item_typeOneOfType\":{\"oneOf\":[{\"properties\":{\"object_type\":{\"const\":\"product\",\"type\":\"string\"},\"product\":{\"$ref\":\"#/$defs/ProductDetails\"}},\"required\":[\"object_type\",\"product\"],\"title\":\"product\",\"type\":\"object\"},{\"properties\":{\"object_type\":{\"const\":\"service\",\"type\":\"string\"},\"service\":{\"$ref\":\"#/$defs/ServiceDetails\"}},\"required\":[\"object_type\",\"service\"],\"title\":\"service\",\"type\":\"object\"}]},\"labels\":{\"additionalProperties\":{\"type\":\"string\"},\"description\":\"Map field\",\"propertyNames\":{\"type\":\"string\"},\"type\":\"object\"},\"name\":{\"description\":\"Required field\",\"type\":\"string\"},\"tags\":{\"description\":\"Repeated field\",\"items\":{\"type\":\"string\"},\"type\":\"array\"},\"thumbnail\":{\"contentEncoding\":\"base64\",\"description\":\"Bytes field\",\"format\":\"byte\",\"type\":\"string\"}},\"required\":[\"name\",\"item_typeOneOfType\"],\"type\":\"object\"}"}
	TestService_GetItemTool               = runtime.Tool{Name: "testdata_TestService_GetItem", Description: "GetItem retrieves an item by ID\n", JSONSchema: "{\"$schema\":\"https://json-schema.org/draft/2020-12/schema\",\"properties\":{\"id\":{\"type\":\"string\"}},\"required\":[],\"type\":\"object\"}"}
	TestService_ProcessWellKnownTypesTool = runtime.Tool{Name: "testdata_TestService_ProcessWellKnownTypes", Description: "Test well-known types handling\n", JSONSchema: "{\"$schema\":\"https://json-schema.org/draft/2020-12/schema\",\"properties\":{\"config\":{\"description\":\"represents a google.protobuf.Value, a dynamic JSON value (string, number, boolean, array, object).\"},\"metadata\":{\"description\":\"Well-known types that need special handling\",\"type\":\"object\"},\"payload\":{\"properties\":{\"@type\":{\"type\":\"string\"},\"value\":{}},\"required\":[\"@type\"],\"type\":[\"object\",\"null\"]},\"timestamp\":{\"format\":\"date-time\",\"type\":[\"string\",\"null\"]}},\"required\":[],\"type\":\"object\"}"}
)

// TestServiceClient is compatible with the grpc-go client interface.
type TestServiceClient interface {
	CreateItem(ctx context.Context, req *testdata.CreateItemRequest, opts ...grpc.CallOption) (*testdata.CreateItemResponse, error)
	GetItem(ctx context.Context, req *testdata.GetItemRequest, opts ...grpc.CallOption) (*testdata.GetItemResponse, error)
	ProcessWellKnownTypes(ctx context.Context, req *testdata.ProcessWellKnownTypesRequest, opts ...grpc.CallOption) (*testdata.ProcessWellKnownTypesResponse, error)
}

// TestServiceNormalizeTopLevelJSONStringsForOneofs scans m's top level and, for keys that end with
// "OneOfType" (as defined in the tool's JSON schema), it will parse string values that look like JSON
// and replace them with the parsed value.
func TestServiceNormalizeTopLevelJSONStringsForOneofs(
	m map[string]interface{},
	toolSchema string,
) (changed bool) {
	if m == nil || toolSchema == "" {
		return false
	}

	// Parse the tool schema to find OneOfType fields
	var schema map[string]interface{}
	if err := json.Unmarshal([]byte(toolSchema), &schema); err != nil {
		return false
	}

	// Extract properties from the schema
	properties, ok := schema["properties"].(map[string]interface{})
	if !ok {
		return false
	}

	// Find all fields ending with "OneOfType"
	oneOfTypeFields := map[string]struct{}{}
	for fieldName := range properties {
		if strings.HasSuffix(fieldName, "OneOfType") {
			oneOfTypeFields[fieldName] = struct{}{}
		}
	}

	// Rewrite top-level stringified JSON for OneOfType fields
	for k, v := range m {
		if _, ok := oneOfTypeFields[k]; !ok {
			continue
		}
		s, ok := v.(string)
		if !ok {
			continue
		}
		trim := strings.TrimSpace(s)
		if trim == "" || !(strings.HasPrefix(trim, "{") || strings.HasPrefix(trim, "[")) {
			continue
		}
		var parsed any
		if err := json.Unmarshal([]byte(trim), &parsed); err != nil {
			continue // ignore if it's not valid JSON
		}
		m[k] = parsed
		changed = true
	}
	return changed
}

// TestServiceTransformOneOfFields transforms discriminated union fields back to protobuf oneOf format
func TestServiceTransformOneOfFields(m map[string]interface{}) {
	TestServiceTransformOneOfFieldsRecursive(m)
}

// TestServiceTransformOneOfFieldsRecursive recursively transforms oneOf fields in nested objects
func TestServiceTransformOneOfFieldsRecursive(obj interface{}) {
	switch v := obj.(type) {
	case map[string]interface{}:
		// Transform oneOf fields in this object
		for key, value := range v {
			// Check if this looks like a oneOf discriminated union (must have OneOfType postfix)
			if strings.HasSuffix(key, "OneOfType") {
				if unionObj, ok := value.(map[string]interface{}); ok {
					if typeField, hasType := unionObj["object_type"]; hasType {
						if typeStr, ok := typeField.(string); ok {
							// First try to extract the field that matches the object_type
							// (for message types with $ref)
							if fieldValue, hasField := unionObj[typeStr]; hasField {
								// Move the field value directly to the parent level
								v[typeStr] = fieldValue
								delete(v, key)
							} else {
								// Fall back to old logic: create object without object_type field
								// (for primitive types or inline objects)
								variantObj := make(map[string]interface{})
								for k, val := range unionObj {
									if k != "object_type" {
										variantObj[k] = val
									}
								}
								// Replace the union object with the variant object
								v[typeStr] = variantObj
								delete(v, key)
							}
						}
					}
				}
			}
		}

		// Recursively process all values
		for _, value := range v {
			TestServiceTransformOneOfFieldsRecursive(value)
		}
	case []interface{}:
		// Process array elements
		for _, item := range v {
			TestServiceTransformOneOfFieldsRecursive(item)
		}
	}
}

// ForwardToTestServiceClient registers a gRPC client, to forward MCP calls to it.
func ForwardToTestServiceClient(s *mcpserver.MCPServer, client TestServiceClient, opts ...runtime.Option) {
	config := runtime.NewConfig()
	for _, opt := range opts {
		opt(config)
	}
	CreateItemToolDef := TestService_CreateItemTool

	// Convert simple Tool to mcp.Tool
	CreateItemTool := mcp.Tool{
		Name:           CreateItemToolDef.Name,
		Description:    CreateItemToolDef.Description,
		RawInputSchema: json.RawMessage(CreateItemToolDef.JSONSchema),
	}

	// Add extra properties to schema if configured
	if len(config.ExtraProperties) > 0 {
		CreateItemTool = runtime.AddExtraPropertiesToTool(CreateItemTool, config.ExtraProperties)
	}

	s.AddTool(CreateItemTool, func(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
		var req testdata.CreateItemRequest

		message := request.GetArguments()

		// Fix oneof's passed as JSON string.
		_ = TestServiceNormalizeTopLevelJSONStringsForOneofs(message, CreateItemToolDef.JSONSchema)

		// Transform oneOf discriminated unions back to protobuf format
		TestServiceTransformOneOfFields(message)

		// Extract extra properties if configured
		for _, prop := range config.ExtraProperties {
			if propVal, ok := message[prop.Name]; ok {
				ctx = context.WithValue(ctx, prop.ContextKey, propVal)
			}
		}

		marshaled, err := json.Marshal(message)
		if err != nil {
			return nil, err
		}

		if err := (protojson.UnmarshalOptions{DiscardUnknown: true}).Unmarshal(marshaled, &req); err != nil {
			return nil, err
		}

		resp, err := client.CreateItem(ctx, &req)
		if err != nil {
			return runtime.HandleError(err)
		}

		marshaled, err = (protojson.MarshalOptions{UseProtoNames: true, EmitDefaultValues: true}).Marshal(resp)
		if err != nil {
			return nil, err
		}
		return mcp.NewToolResultText(string(marshaled)), nil
	})
	GetItemToolDef := TestService_GetItemTool

	// Convert simple Tool to mcp.Tool
	GetItemTool := mcp.Tool{
		Name:           GetItemToolDef.Name,
		Description:    GetItemToolDef.Description,
		RawInputSchema: json.RawMessage(GetItemToolDef.JSONSchema),
	}

	// Add extra properties to schema if configured
	if len(config.ExtraProperties) > 0 {
		GetItemTool = runtime.AddExtraPropertiesToTool(GetItemTool, config.ExtraProperties)
	}

	s.AddTool(GetItemTool, func(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
		var req testdata.GetItemRequest

		message := request.GetArguments()

		// Fix oneof's passed as JSON string.
		_ = TestServiceNormalizeTopLevelJSONStringsForOneofs(message, GetItemToolDef.JSONSchema)

		// Transform oneOf discriminated unions back to protobuf format
		TestServiceTransformOneOfFields(message)

		// Extract extra properties if configured
		for _, prop := range config.ExtraProperties {
			if propVal, ok := message[prop.Name]; ok {
				ctx = context.WithValue(ctx, prop.ContextKey, propVal)
			}
		}

		marshaled, err := json.Marshal(message)
		if err != nil {
			return nil, err
		}

		if err := (protojson.UnmarshalOptions{DiscardUnknown: true}).Unmarshal(marshaled, &req); err != nil {
			return nil, err
		}

		resp, err := client.GetItem(ctx, &req)
		if err != nil {
			return runtime.HandleError(err)
		}

		marshaled, err = (protojson.MarshalOptions{UseProtoNames: true, EmitDefaultValues: true}).Marshal(resp)
		if err != nil {
			return nil, err
		}
		return mcp.NewToolResultText(string(marshaled)), nil
	})
	ProcessWellKnownTypesToolDef := TestService_ProcessWellKnownTypesTool

	// Convert simple Tool to mcp.Tool
	ProcessWellKnownTypesTool := mcp.Tool{
		Name:           ProcessWellKnownTypesToolDef.Name,
		Description:    ProcessWellKnownTypesToolDef.Description,
		RawInputSchema: json.RawMessage(ProcessWellKnownTypesToolDef.JSONSchema),
	}

	// Add extra properties to schema if configured
	if len(config.ExtraProperties) > 0 {
		ProcessWellKnownTypesTool = runtime.AddExtraPropertiesToTool(ProcessWellKnownTypesTool, config.ExtraProperties)
	}

	s.AddTool(ProcessWellKnownTypesTool, func(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
		var req testdata.ProcessWellKnownTypesRequest

		message := request.GetArguments()

		// Fix oneof's passed as JSON string.
		_ = TestServiceNormalizeTopLevelJSONStringsForOneofs(message, ProcessWellKnownTypesToolDef.JSONSchema)

		// Transform oneOf discriminated unions back to protobuf format
		TestServiceTransformOneOfFields(message)

		// Extract extra properties if configured
		for _, prop := range config.ExtraProperties {
			if propVal, ok := message[prop.Name]; ok {
				ctx = context.WithValue(ctx, prop.ContextKey, propVal)
			}
		}

		marshaled, err := json.Marshal(message)
		if err != nil {
			return nil, err
		}

		if err := (protojson.UnmarshalOptions{DiscardUnknown: true}).Unmarshal(marshaled, &req); err != nil {
			return nil, err
		}

		resp, err := client.ProcessWellKnownTypes(ctx, &req)
		if err != nil {
			return runtime.HandleError(err)
		}

		marshaled, err = (protojson.MarshalOptions{UseProtoNames: true, EmitDefaultValues: true}).Marshal(resp)
		if err != nil {
			return nil, err
		}
		return mcp.NewToolResultText(string(marshaled)), nil
	})
}
